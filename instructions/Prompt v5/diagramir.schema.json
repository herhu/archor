{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "DiagramIR v1",
  "description": "Intermediate Representation (IR) for UML-like diagrams used by Archon. Supports use-case, class, component, and sequence diagrams.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "diagrams"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema/IR version."
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "description": "Optional provenance of this IR (e.g., the ASCII DSL input).",
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "ascii-dsl",
            "image",
            "other"
          ]
        },
        "uri": {
          "type": "string"
        },
        "text": {
          "type": "string"
        },
        "hash": {
          "type": "string"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "diagrams": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/Diagram"
      }
    },
    "warnings": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Diagnostic"
      }
    }
  },
  "definitions": {
    "Id": {
      "type": "string",
      "pattern": "^[A-Za-z_][A-Za-z0-9_\\-:.]*$",
      "description": "Stable identifier. Use dotted or namespaced forms (e.g., 'class.User', 'component.queue')."
    },
    "Ref": {
      "$ref": "#/definitions/Id"
    },
    "Position": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "x": {
          "type": "number"
        },
        "y": {
          "type": "number"
        },
        "w": {
          "type": "number"
        },
        "h": {
          "type": "number"
        }
      },
      "description": "Optional layout position in an abstract coordinate system."
    },
    "SourceSpan": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "startLine": {
          "type": "integer",
          "minimum": 1
        },
        "startCol": {
          "type": "integer",
          "minimum": 1
        },
        "endLine": {
          "type": "integer",
          "minimum": 1
        },
        "endCol": {
          "type": "integer",
          "minimum": 1
        }
      },
      "required": [
        "startLine",
        "startCol",
        "endLine",
        "endCol"
      ]
    },
    "TaggedValue": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "key",
        "value"
      ],
      "properties": {
        "key": {
          "type": "string",
          "minLength": 1
        },
        "value": {
          "type": [
            "string",
            "number",
            "boolean",
            "null"
          ]
        },
        "namespace": {
          "type": "string",
          "description": "Optional namespace/prefix for the tag key."
        }
      }
    },
    "Documentation": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "summary": {
          "type": "string"
        },
        "details": {
          "type": "string"
        },
        "examples": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "Diagnostic": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "severity",
        "message"
      ],
      "properties": {
        "severity": {
          "type": "string",
          "enum": [
            "info",
            "warning",
            "error"
          ]
        },
        "code": {
          "type": "string"
        },
        "message": {
          "type": "string"
        },
        "path": {
          "type": "string",
          "description": "JSON pointer-like hint into the IR."
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        }
      }
    },
    "ElementBase": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "type",
        "name"
      ],
      "properties": {
        "id": {
          "$ref": "#/definitions/Id"
        },
        "type": {
          "type": "string"
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "stereotypes": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaggedValue"
          }
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        },
        "position": {
          "$ref": "#/definitions/Position"
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        }
      }
    },
    "Actor": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "properties": {
            "type": {
              "const": "actor"
            }
          }
        }
      ]
    },
    "UseCase": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "properties": {
            "type": {
              "const": "usecase"
            }
          }
        }
      ]
    },
    "Visibility": {
      "type": "string",
      "enum": [
        "public",
        "protected",
        "private",
        "package"
      ]
    },
    "TypeRef": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Type name as written (e.g., 'string', 'UUID', 'User')."
        },
        "genericArgs": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TypeRef"
          }
        },
        "nullable": {
          "type": "boolean"
        },
        "isArray": {
          "type": "boolean"
        },
        "refId": {
          "$ref": "#/definitions/Id",
          "description": "Optional link to another element id if resolvable."
        }
      }
    },
    "Attribute": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "typeRef"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "visibility": {
          "$ref": "#/definitions/Visibility"
        },
        "typeRef": {
          "$ref": "#/definitions/TypeRef"
        },
        "static": {
          "type": "boolean"
        },
        "readonly": {
          "type": "boolean"
        },
        "default": {
          "type": [
            "string",
            "number",
            "boolean",
            "null"
          ]
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaggedValue"
          }
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        }
      }
    },
    "Parameter": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "typeRef"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "typeRef": {
          "$ref": "#/definitions/TypeRef"
        },
        "default": {
          "type": [
            "string",
            "number",
            "boolean",
            "null"
          ]
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        }
      }
    },
    "Operation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "visibility": {
          "$ref": "#/definitions/Visibility"
        },
        "params": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Parameter"
          }
        },
        "returns": {
          "$ref": "#/definitions/TypeRef"
        },
        "static": {
          "type": "boolean"
        },
        "abstract": {
          "type": "boolean"
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaggedValue"
          }
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        }
      }
    },
    "Class": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "required": [
            "kind"
          ],
          "properties": {
            "type": {
              "const": "classifier"
            },
            "kind": {
              "type": "string",
              "enum": [
                "class",
                "abstract",
                "interface",
                "enum",
                "valueobject"
              ]
            },
            "attributes": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Attribute"
              }
            },
            "operations": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Operation"
              }
            },
            "extends": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Id"
              }
            },
            "implements": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Id"
              }
            }
          }
        }
      ]
    },
    "EnumLiteral": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "value": {
          "type": [
            "string",
            "number",
            "null"
          ]
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        }
      }
    },
    "Port": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "direction": {
          "type": "string",
          "enum": [
            "provides",
            "requires"
          ]
        },
        "interface": {
          "$ref": "#/definitions/Id"
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        }
      }
    },
    "Component": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "properties": {
            "type": {
              "const": "component"
            },
            "ports": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Port"
              }
            },
            "contains": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Id"
              }
            }
          }
        }
      ]
    },
    "Interface": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "properties": {
            "type": {
              "const": "interface"
            },
            "operations": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Operation"
              }
            }
          }
        }
      ]
    },
    "Participant": {
      "allOf": [
        {
          "$ref": "#/definitions/ElementBase"
        },
        {
          "properties": {
            "type": {
              "const": "participant"
            },
            "role": {
              "type": "string",
              "enum": [
                "actor",
                "boundary",
                "control",
                "entity",
                "service",
                "component",
                "database",
                "queue",
                "external"
              ]
            },
            "classifier": {
              "$ref": "#/definitions/Id",
              "description": "Optional link to a Class/Component element id."
            }
          }
        }
      ]
    },
    "Message": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "from",
        "to",
        "kind",
        "label"
      ],
      "properties": {
        "id": {
          "$ref": "#/definitions/Id"
        },
        "from": {
          "$ref": "#/definitions/Id"
        },
        "to": {
          "$ref": "#/definitions/Id"
        },
        "kind": {
          "type": "string",
          "enum": [
            "sync",
            "async",
            "reply",
            "create",
            "destroy"
          ]
        },
        "label": {
          "type": "string"
        },
        "sequence": {
          "type": "integer",
          "minimum": 1,
          "description": "Monotonic message ordering."
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaggedValue"
          }
        }
      }
    },
    "Fragment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "start",
        "end"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "enum": [
            "alt",
            "opt",
            "loop",
            "par",
            "break",
            "critical"
          ]
        },
        "condition": {
          "type": "string"
        },
        "start": {
          "type": "integer",
          "minimum": 1,
          "description": "Message sequence index where fragment begins."
        },
        "end": {
          "type": "integer",
          "minimum": 1,
          "description": "Message sequence index where fragment ends (inclusive)."
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        }
      }
    },
    "Multiplicity": {
      "type": "string",
      "pattern": "^(\\*|\\d+)(\\.\\.(\\*|\\d+))?$",
      "description": "UML multiplicity, e.g., '1', '0..1', '1..*', '*'."
    },
    "Relationship": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "type",
        "from",
        "to"
      ],
      "properties": {
        "id": {
          "$ref": "#/definitions/Id"
        },
        "type": {
          "type": "string",
          "enum": [
            "association",
            "aggregation",
            "composition",
            "dependency",
            "realization",
            "generalization",
            "usecase-association",
            "include",
            "extend",
            "message"
          ]
        },
        "from": {
          "$ref": "#/definitions/Id"
        },
        "to": {
          "$ref": "#/definitions/Id"
        },
        "label": {
          "type": "string"
        },
        "fromMultiplicity": {
          "$ref": "#/definitions/Multiplicity"
        },
        "toMultiplicity": {
          "$ref": "#/definitions/Multiplicity"
        },
        "navigability": {
          "type": "string",
          "enum": [
            "none",
            "from-to",
            "to-from",
            "both"
          ]
        },
        "span": {
          "$ref": "#/definitions/SourceSpan"
        },
        "tags": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/TaggedValue"
          }
        }
      }
    },
    "Diagram": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "kind",
        "name",
        "elements",
        "relationships"
      ],
      "properties": {
        "id": {
          "$ref": "#/definitions/Id"
        },
        "kind": {
          "type": "string",
          "enum": [
            "usecase",
            "class",
            "component",
            "sequence"
          ]
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "doc": {
          "$ref": "#/definitions/Documentation"
        },
        "elements": {
          "type": "array",
          "items": {
            "oneOf": [
              {
                "$ref": "#/definitions/Actor"
              },
              {
                "$ref": "#/definitions/UseCase"
              },
              {
                "$ref": "#/definitions/Class"
              },
              {
                "$ref": "#/definitions/Component"
              },
              {
                "$ref": "#/definitions/Interface"
              },
              {
                "$ref": "#/definitions/Participant"
              }
            ]
          }
        },
        "relationships": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Relationship"
          }
        },
        "messages": {
          "type": "array",
          "description": "Sequence diagram messages. Duplicated as relationships of type 'message' for graph algorithms.",
          "items": {
            "$ref": "#/definitions/Message"
          }
        },
        "fragments": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Fragment"
          }
        },
        "layoutHint": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "direction": {
              "type": "string",
              "enum": [
                "LR",
                "TB",
                "RL",
                "BT"
              ]
            },
            "engine": {
              "type": "string",
              "enum": [
                "none",
                "dot",
                "elk",
                "manual"
              ]
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "kind": {
                "const": "sequence"
              }
            }
          },
          "then": {
            "required": [
              "messages"
            ],
            "properties": {
              "elements": {
                "items": {
                  "$ref": "#/definitions/Participant"
                }
              }
            }
          }
        }
      ]
    }
  }
}

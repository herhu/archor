import { Module, NestModule, MiddlewareConsumer, RequestMethod } from '@nestjs/common';
import { ConfigModule } from './shared/config/config.module';
import { LoggerModule } from './shared/logging/logger.module';
import { HealthModule } from './shared/health/health.module';
import { CorrelationIdMiddleware } from './shared/middleware/correlation-id.middleware';
import { ThrottlerModule } from '@nestjs/throttler';
import { APP_GUARD } from '@nestjs/core';
import { ThrottlerGuard } from '@nestjs/throttler';

{{#each domainModules}}
import { {{this.className}} } from '{{this.importPath}}';
{{/each}}

@Module({
imports: [
ConfigModule,
LoggerModule,

{{#if platform.throttling}}
ThrottlerModule.forRoot([{
ttl: Number(process.env.RATE_LIMIT_TTL ?? {{platform.rateLimitTtl}}),
limit: Number(process.env.RATE_LIMIT_MAX ?? {{platform.rateLimitMax}})
}]),
{{/if}}

HealthModule,

// Domain modules
{{#each domainModules}}
{{this.className}},
{{/each}}
],
providers: [
{{#if platform.throttling}}
{
provide: APP_GUARD,
useClass: ThrottlerGuard
}
{{/if}}
]
})
export class AppModule implements NestModule {
configure(consumer: MiddlewareConsumer) {
consumer
.apply(CorrelationIdMiddleware)
.forRoutes({ path: '*', method: RequestMethod.ALL });
}
}
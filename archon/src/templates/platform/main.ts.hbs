import 'reflect-metadata';
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import cookieParser from 'cookie-parser';
import helmet from 'helmet';
import { AppModule } from './app.module';
import { setupSwagger } from './shared/swagger/swagger';
import { HttpExceptionFilter } from './shared/filters/http-exception.filter';

function parseOrigins(raw?: string): string[] {
  if (!raw) return [];
  return raw.split(',').map(s => s.trim()).filter(Boolean);
}

async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    bufferLogs: true
  });

  const globalPrefix = process.env.API_PREFIX || '{{apiPrefix}}';
  app.setGlobalPrefix(globalPrefix);

  // Security headers
  {{#if platform.securityHeaders}}
  app.use(helmet());
  {{/if}}

  // Cookies (for future AuthPack / refresh cookies)
  {{#if platform.cookieParser}}
  app.use(cookieParser());
  {{/if}}

  // CORS
  {{#if platform.cors}}
  const origins = parseOrigins(process.env.CORS_ORIGINS);
  app.enableCors({
    origin: origins.length ? origins : true, // dev-friendly
    credentials: true,
    methods: ['GET','POST','PUT','PATCH','DELETE','OPTIONS'],
    allowedHeaders: ['Content-Type','Authorization','X-Correlation-Id'],
    exposedHeaders: ['X-Correlation-Id']
  });
  {{/if}}

  // Body size limits (express defaults are OK; keep explicit for clarity)
  // If you later add file uploads, split limits per route.
  {{#if platform.maxBodySize}}
  app.use(require('express').json({ limit: '{{platform.maxBodySize}}' }));
  app.use(require('express').urlencoded({ extended: true, limit: '{{platform.maxBodySize}}' }));
  {{/if}}

  // Validation
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true
    })
  );

  // Global error shape
  app.useGlobalFilters(new HttpExceptionFilter());

  // Swagger
  {{#if platform.swagger}}
  setupSwagger(app);
  {{/if}}

  const port = process.env.PORT ? Number(process.env.PORT) : {{port}};
  await app.listen(port);

  // eslint-disable-next-line no-console
  console.log(`API running: http://localhost:${port}/${globalPrefix}`);
  {{#if platform.swagger}}
  // eslint-disable-next-line no-console
  console.log(`Swagger: http://localhost:${port}/docs`);
  {{/if}}
}

bootstrap();

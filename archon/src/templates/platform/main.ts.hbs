import 'reflect-metadata';
import { NestFactory } from '@nestjs/core';
import { NestExpressApplication } from '@nestjs/platform-express';
import { ValidationPipe } from '@nestjs/common';
import { PinoLogger } from 'nestjs-pino';
import cookieParser from 'cookie-parser';
import helmet from 'helmet';
import { AppModule } from './app.module';
import { setupSwagger } from './shared/swagger/swagger';
import { HttpExceptionFilter } from './shared/filters/http-exception.filter';

function parseOrigins(raw?: string): string[] {
if (!raw) return [];
return raw.split(',').map(s => s.trim()).filter(Boolean);
}

async function bootstrap() {
const app = await NestFactory.create<NestExpressApplication>(AppModule, {
    bufferLogs: true
    });

    // Use structured logger
    app.useLogger(app.get(PinoLogger));
    app.flushLogs();

    // Graceful shutdown
    app.enableShutdownHooks();

    const globalPrefix = process.env.API_PREFIX || '{{apiPrefix}}';
    app.setGlobalPrefix(globalPrefix);

    // Security headers
    {{#if platform.securityHeaders}}
    app.use(helmet());
    {{/if}}

    // Cookies (for future AuthPack / refresh cookies)
    {{#if platform.cookieParser}}
    app.use(cookieParser());
    {{/if}}

    // CORS
    {{#if platform.cors}}
    const isProd = process.env.NODE_ENV === 'production';
    const rawOrigins = process.env.CORS_ORIGINS;
    let origins: string[] | boolean = parseOrigins(rawOrigins);

    if (isProd && Array.isArray(origins) && origins.length === 0) {
    // Fail secure in production
    throw new Error('Using production mode but CORS_ORIGINS is empty. Set it to allowed domains.');
    }

    // Dev-friendly: allow all if no explicit origins (and not prod)
    if (!isProd && (!Array.isArray(origins) || origins.length === 0)) {
    origins = true;
    }

    app.enableCors({
    origin: origins,
    credentials: true,
    methods: ['GET','POST','PUT','PATCH','DELETE','OPTIONS'],
    allowedHeaders: ['Content-Type','Authorization','X-Correlation-Id'],
    exposedHeaders: ['X-Correlation-Id']
    });
    {{/if}}

    // Body size limits (Using NestJS platform adapter, avoiding direct express require)
    {{#if platform.maxBodySize}}
    app.useBodyParser('json', { limit: '{{platform.maxBodySize}}' });
    app.useBodyParser('urlencoded', { extended: true, limit: '{{platform.maxBodySize}}' });
    {{/if}}

    // Validation
    app.useGlobalPipes(
    new ValidationPipe({
    whitelist: true,
    forbidNonWhitelisted: true,
    transform: true
    })
    );

    // Global error shape
    app.useGlobalFilters(new HttpExceptionFilter());

    // Swagger
    {{#if platform.swagger}}
    setupSwagger(app);
    {{/if}}

    const port = process.env.PORT ? Number(process.env.PORT) : {{port}};
    await app.listen(port);

    // eslint-disable-next-line no-console
    console.log(`API running: http://localhost:${port}/${globalPrefix}`);
    {{#if platform.swagger}}
    // eslint-disable-next-line no-console
    console.log(`Swagger: http://localhost:${port}/docs`);
    {{/if}}
    }

    bootstrap();